<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Three.js FPS with Joystick and Gun</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background-color: #202020;
    font-family: sans-serif;
    user-select: none;
  }
  #instructions {
    position: absolute;
    top: 40%;
    width: 100%;
    text-align: center;
    color: white;
    font-size: 24px;
    cursor: pointer;
    user-select: none;
    z-index: 10;
  }
  #crosshair {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin-left: -10px;
    margin-top: -10px;
    pointer-events: none;
    z-index: 10;
  }
  #crosshair:before, #crosshair:after {
    content: '';
    position: absolute;
    background: white;
  }
  #crosshair:before {
    left: 50%;
    top: 0;
    width: 2px;
    height: 20px;
    margin-left: -1px;
  }
  #crosshair:after {
    top: 50%;
    left: 0;
    width: 20px;
    height: 2px;
    margin-top: -1px;
  }
  #ammo {
    position: absolute;
    bottom: 20px;
    right: 20px;
    color: white;
    font-size: 18px;
    z-index: 10;
  }
  /* Joystick container */
  #joystick-container {
    position: absolute;
    bottom: 20px;
    left: 20px;
    width: 120px;
    height: 120px;
    touch-action: none;
    z-index: 10;
  }
</style>
</head>
<body>
<div id="instructions">Click to play</div>
<div id="crosshair"></div>
<div id="ammo">Ammo: 10 / 10</div>
<div id="joystick-container"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/PointerLockControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>

<script>
// --- Setup Three.js Scene, Camera, Renderer ---
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x202020);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);

const renderer = new THREE.WebGLRenderer({antialias: true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Lighting
const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
scene.add(ambientLight);

// Floor
const floorGeometry = new THREE.PlaneGeometry(100, 100);
const floorMaterial = new THREE.MeshStandardMaterial({color: 0x555555});
const floor = new THREE.Mesh(floorGeometry, floorMaterial);
floor.rotation.x = -Math.PI / 2;
floor.receiveShadow = true;
scene.add(floor);

// Cube target
const cubeGeometry = new THREE.BoxGeometry(1, 1, 1);
const cubeMaterial = new THREE.MeshStandardMaterial({color: 0xff0000});
const cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
cube.position.set(0, 1, -5);
scene.add(cube);

// PointerLockControls
const controls = new THREE.PointerLockControls(camera, document.body);
scene.add(controls.getObject());

const instructions = document.getElementById('instructions');
instructions.addEventListener('click', () => {
  controls.lock();
});

controls.addEventListener('lock', () => {
  instructions.style.display = 'none';
});

controls.addEventListener('unlock', () => {
  instructions.style.display = '';
});

// Movement setup
const move = { forward: false, backward: false, left: false, right: false };
const velocity = new THREE.Vector3();
const direction = new THREE.Vector3();
const speed = 10.0;

document.addEventListener('keydown', (event) => {
  switch(event.code) {
    case 'KeyW': move.forward = true; break;
    case 'KeyS': move.backward = true; break;
    case 'KeyA': move.left = true; break;
    case 'KeyD': move.right = true; break;
  }
});
document.addEventListener('keyup', (event) => {
  switch(event.code) {
    case 'KeyW': move.forward = false; break;
    case 'KeyS': move.backward = false; break;
    case 'KeyA': move.left = false; break;
    case 'KeyD': move.right = false; break;
  }
});

// Position the camera at start
controls.getObject().position.set(0, 1.6, 5);

// Ammo system
let ammo = 10;
const maxAmmo = 10;
const ammoDisplay = document.getElementById('ammo');

function updateAmmo() {
  ammoDisplay.textContent = `Ammo: ${ammo} / ${maxAmmo}`;
}
updateAmmo();

// Raycaster for shooting
const raycaster = new THREE.Raycaster();
const shootRange = 100;

function shoot() {
  if (ammo <= 0) {
    console.log("Out of ammo! Reload!");
    return;
  }
  ammo--;
  updateAmmo();

  // Raycast from camera center forward
  const shootDirection = new THREE.Vector3();
  camera.getWorldDirection(shootDirection);
  raycaster.set(camera.position, shootDirection);

  const intersects = raycaster.intersectObjects([cube]);
  if (intersects.length > 0) {
    console.log("Hit the cube!");
    // Simple effect: change cube color on hit
    cube.material.color.set(0x00ff00);
    setTimeout(() => cube.material.color.set(0xff0000), 200);
  }
}

// Shoot on click or tap
document.addEventListener('click', () => {
  if (controls.isLocked) shoot();
});

// --- Load Gun Model ---
const loader = new THREE.GLTFLoader();
let gun;
loader.load(
  'assets/gun.glb',
  (gltf) => {
    gun = gltf.scene;
    gun.scale.set(1.5,1.5,1.5);
    gun.position.set(0.5, -0.8, -1); // Adjust for FPS view
    camera.add(gun);
  },
  undefined,
  (error) => {
    console.error('Failed to load gun model:', error);
  }
);

// --- Joystick Implementation ---
class SimpleJoystick {
  constructor(container, onMove) {
    this.container = container;
    this.onMove = onMove;
    this.pointerId = null;
    this.origin = null;
    this.stick = document.createElement('div');
    Object.assign(this.stick.style, {
      position: 'absolute',
      width: '80px',
      height: '80px',
      background: 'rgba(255,255,255,0.3)',
      borderRadius: '50%',
      top: '20px',
      left: '20px',
      touchAction: 'none',
    });
    this.thumb = document.createElement('div');
    Object.assign(this.thumb.style, {
      position: 'absolute',
      width: '40px',
      height: '40px',
      background: 'rgba(255,255,255,0.7)',
      borderRadius: '50%',
      top: '20px',
      left: '20px',
      transform: 'translate(20px,20px)',
      touchAction: 'none',
    });
    this.stick.appendChild(this.thumb);
    this.container.appendChild(this.stick);

    this.stick.addEventListener('pointerdown', (e) => {
      if (this.pointerId !== null) return;
      this.pointerId = e.pointerId;
      this.origin = {x: e.clientX, y: e.clientY};
      this.thumb.style.transition = 'none';
      this.thumb.style.transform = 'translate(20px,20px)';
      e.target.setPointerCapture(this.pointerId);
    });

    this.stick.addEventListener('pointermove', (e) => {
      if (e.pointerId !== this.pointerId) return;
      const dx = e.clientX - this.origin.x;
      const dy = e.clientY - this.origin.y;
      const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
      const angle = Math.atan2(dy, dx);
      const x = Math.cos(angle) * dist;
      const y = Math.sin(angle) * dist;
      this.thumb.style.transform = `translate(${20 + x}px, ${20 + y}px)`;

      // Normalize to [-1,1]
      const nx = x / 40;
      const ny = y / 40;
      this.onMove(nx, ny);
    });

    this.stick.addEventListener('pointerup', (e) => {
      if (e.pointerId !== this.pointerId) return;
      this.pointerId = null;
      this.thumb.style.transition = 'transform 0.3s ease';
      this.thumb.style.transform = 'translate(20px,20px)';
      this.onMove(0, 0);
    });

    this.stick.addEventListener('pointercancel', (e) => {
      if (e.pointerId !== this.pointerId) return;
      this.pointerId = null;
      this.thumb.style.transition = 'transform 0.3s ease';
      this.thumb.style.transform = 'translate(20px,20px)';
      this.onMove(0, 0);
    });
  }
}

// Create joystick and handle movement
const joystickContainer = document.getElementById('joystick-container');
const joystick = new SimpleJoystick(joystickContainer, (x, y) => {
  move.right = x > 0.2;
  move.left = x < -0.2;
  move.forward = y < -0.2;
  move.backward = y > 0.2;
});

// --- Animation Loop ---
let prevTime = performance.now();
function animate() {
  requestAnimationFrame(animate);

  const time = performance.now();
  const delta = (time - prevTime) / 1000;

  if (controls.isLocked === true) {
    velocity.x -= velocity.x * 10.0 * delta;
    velocity.z -= velocity.z * 10.0 * delta;

    direction.z = Number(move.forward) - Number(move.backward);
    direction.x = Number(move.right) - Number(move.left);
    direction.normalize();

    if (move.forward || move.backward) velocity.z -= direction.z * speed * delta;
    if (move.left || move.right) velocity.x -= direction.x * speed * delta;

    controls.moveRight(-velocity.x * delta);
    controls.moveForward(-velocity.z * delta);
  }

  prevTime = time;
  renderer.render(scene, camera);
}
animate();

window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
