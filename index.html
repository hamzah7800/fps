<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FPS Game with Joystick and Grass</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      touch-action: none;
    }
    canvas { display: block; }

    #joystick-container {
      position: absolute;
      bottom: 80px;
      left: 80px;
      width: 150px;
      height: 150px;
      z-index: 10;
    }

    #shoot-button {
      position: absolute;
      bottom: 100px;
      right: 60px;
      width: 80px;
      height: 80px;
      background: rgba(255, 0, 0, 0.5);
      border-radius: 50%;
      border: 2px solid white;
      font-size: 18px;
      color: white;
      text-align: center;
      line-height: 80px;
      user-select: none;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="joystick-container"></div>
  <div id="shoot-button">Shoot</div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/PointerLockControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>

  <script>
    let scene = new THREE.Scene();
    let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    let renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Lights
    let light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(50, 50, 50);
    scene.add(light);

    // Grass Texture
    const loader = new THREE.TextureLoader();
    const grassTexture = loader.load('https://threejs.org/examples/textures/grasslight-big.jpg');
    grassTexture.wrapS = THREE.RepeatWrapping;
    grassTexture.wrapT = THREE.RepeatWrapping;
    grassTexture.repeat.set(100, 100);

    // Ground
    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(1000, 1000),
      new THREE.MeshLambertMaterial({ map: grassTexture })
    );
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    // Player
    let controls = new THREE.PointerLockControls(camera, renderer.domElement);
    scene.add(controls.getObject());
    let velocity = new THREE.Vector3();
    let direction = new THREE.Vector3();
    let canJump = false;

    document.body.addEventListener('click', () => controls.lock());
    controls.addEventListener('lock', () => {});
    controls.addEventListener('unlock', () => {});

    // Bullets
    const bullets = [];

    function shootBullet() {
      let bullet = new THREE.Mesh(
        new THREE.SphereGeometry(0.1, 8, 8),
        new THREE.MeshBasicMaterial({ color: 0xff0000 })
      );
      bullet.position.copy(camera.position);
      bullet.quaternion.copy(camera.quaternion);
      scene.add(bullet);

      let dir = new THREE.Vector3();
      camera.getWorldDirection(dir);
      bullets.push({ mesh: bullet, velocity: dir.multiplyScalar(1) });
    }

    // Mobile Shoot Button
    document.getElementById('shoot-button').addEventListener('touchstart', shootBullet);

    // Joystick
    const joystick = nipplejs.create({
      zone: document.getElementById('joystick-container'),
      mode: 'static',
      position: { left: '50%', top: '50%' },
      color: 'white'
    });

    let joystickMove = { forward: 0, right: 0 };

    joystick.on('move', (evt, data) => {
      const angle = data.angle.degree;
      const distance = data.distance;
      joystickMove.forward = Math.cos(angle * Math.PI / 180) * distance / 50;
      joystickMove.right = Math.sin(angle * Math.PI / 180) * distance / 50;
    });

    joystick.on('end', () => {
      joystickMove.forward = 0;
      joystickMove.right = 0;
    });

    // Controls
    const keys = {};
    document.addEventListener('keydown', e => keys[e.code] = true);
    document.addEventListener('keyup', e => keys[e.code] = false);

    // Animation
    let prevTime = performance.now();
    function animate() {
      requestAnimationFrame(animate);

      const time = performance.now();
      const delta = (time - prevTime) / 1000;

      velocity.x -= velocity.x * 10.0 * delta;
      velocity.z -= velocity.z * 10.0 * delta;
      velocity.y -= 9.8 * delta; // gravity

      direction.z = (keys['KeyW'] ? 1 : 0) - (keys['KeyS'] ? 1 : 0) + joystickMove.forward;
      direction.x = (keys['KeyD'] ? 1 : 0) - (keys['KeyA'] ? 1 : 0) + joystickMove.right;
      direction.normalize();

      if (direction.length() > 0) {
        velocity.z -= direction.z * 50.0 * delta;
        velocity.x -= direction.x * 50.0 * delta;
      }

      controls.moveRight(-velocity.x * delta);
      controls.moveForward(-velocity.z * delta);
      controls.getObject().position.y += velocity.y * delta;

      if (controls.getObject().position.y < 2) {
        velocity.y = 0;
        controls.getObject().position.y = 2;
        canJump = true;
      }

      // Bullets update
      bullets.forEach((b, i) => {
        b.mesh.position.add(b.velocity.clone().multiplyScalar(delta * 30));
        if (b.mesh.position.length() > 500) {
          scene.remove(b.mesh);
          bullets.splice(i, 1);
        }
      });

      renderer.render(scene, camera);
      prevTime = time;
    }
    animate();

    // Resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
